{% extends 'base.html' %}

{% load static %}


{% block title %}Map{% endblock %}


{% block head %}
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{% static 'awesome_markers/leaflet.awesome-markers.css' %}" />

  <style>
    html, body, #map {
      width:100%;
      height:100%;
      margin:0;
      padding:0;
      background-color: #B0B0B0
    }
  </style>

{% endblock %}


{% block body %}

    {% csrf_token %}

  <div id="map"></div>


  <div class="offcanvas offcanvas-end" tabindex="-1" id="markerOffcanvas">
    <div class="offcanvas-header">
      <h5 id="offcanvasRightLabel">Add new marker</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <form action="javascript:sendMarkerData()">
        <div class="row mb-3">
          <label class="form-label">
            Title
            <input class="form-control" type="text" name="name" value="" required />
          </label>
        </div>

        <div class="row mb-3">
          <label class="form-label">
            Description
            <textarea class="form-control" name="description" placeholder=""></textarea>
          </label>
        </div>

        <div class="row mb-3">
          <label class="form-label">
            Color
            <select class="form-select" name="color" required>
              {% for color_option in marker_color_options %}
                <option value="{{ color_option }}" {% if color_option == 'blue' %}selected{% endif %}>
                  {{ color_option }}
                </option>
              {% endfor %}
            </select>
          </label>
        </div>

        <div class="row mb-3">
          <label class="form-label">
            Icon
            <input class="form-control" type="text" name="icon" value="circle" required />
          </label>
          <div class="form-text"><a href="https://fontawesome.com/v5/search?m=free">See available icons</a></div>
        </div>

        <div class="row mb-3">
          <label class="form-label">
            Icon color
            <input class="form-control" type="color" name="icon_color" value="#ffffff" required />
          </label>
        </div>

        <div class="row mb-3">
          <label class="form-label">
            Select layer
            <select class="form-select" name="layer_id" required>
              {% for layer_id, layer_name in layers.items %}
                <option value="{{ layer_id }}" {% if forloop.first %}selected{% endif %}>
                  {{ layer_name }}
                </option>
              {% endfor %}
            </select>
          </label>
        </div>

        <input type="hidden" name="id" value="" />
        <input type="hidden" name="latitude" />
        <input type="hidden" name="longitude" />

        <button type="submit" class="btn btn-primary">Submit</button>

      </form>
    </div>
  </div>

{% endblock %}


{% block script %}

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
          integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
          crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"
          integrity="sha512-Tn2m0TIpgVyTzzvmxLNuqbSJH3JP8jm+Cy3hvHrW7ndTDcJ1w5mBiksqDBb8GpE2ksktFvDB/ykZ0mDpsZj20w=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer"></script>
  <script src="{% static 'awesome_markers/leaflet.awesome-markers.js' %}"></script>

  <script src="{% static 'rastercoords.js' %}"></script>

  <script>
      let map;
      let component_layers = [];
      let layer_control;
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      (function setupMap() {
          let img = [
              {{ map_obj.width }},
              {{ map_obj.height }},
          ]
          map = L.map('map', {
              crs: L.CRS.Simple,
          })
          const raster_coords = new L.RasterCoords(map, img)
          map.setMaxZoom(raster_coords.zoomLevel())
          map.setView(raster_coords.unproject([img[0], img[1]]), 2)

          L.tileLayer('{{ map_obj.tiles_urlpath }}{z}/{x}/{y}.png', {
              noWrap: true,
              bounds: raster_coords.getMaxBounds(),
              maxNativeZoom: raster_coords.zoomLevel()
          }).addTo(map)

          layer_control = L.control.layers({}, {}, {collapsed: false}).addTo(map);

          getComponents();

          map.on('click', prepareNewMarkerOffcanvas);

          map.on('zoomend', function() {
              const zoom = map.getZoom();
              for (let layer of layer_control._layers) {
                  if (zoom < Number(layer.name.replace('zoom ', ''))) {
                      map.removeLayer(layer.layer);
                  } else {
                      map.addLayer(layer.layer);
                  }
              }

          })

      })();

      function clearComponents() {
          while (component_layers.length > 0) {
              let layer = component_layers.pop();
              layer_control.removeLayer(layer);
              map.removeLayer(layer);
          }
      }

      function getComponents() {
          const xhttp = new XMLHttpRequest();
          xhttp.onload = function() {
              const data = JSON.parse(xhttp.responseText);
              for (let layer of data) {
                  let layer_group = L.layerGroup([]).addTo(map);
                  component_layers.push(layer_group);
                  layer_control.addOverlay(layer_group, layer.name);
                  for (let marker of layer.markers) {
                      const icon = L.AwesomeMarkers.icon({
                          markerColor: marker.color,
                          icon: marker.icon,
                          iconColor: marker.icon_color,
                      });
                      L.marker([marker.latitude, marker.longitude], {_data: marker, icon: icon})
                          .addTo(layer_group)
                          .bindTooltip(marker.name)
                          .on('click', prepareExistingMarkerOffcanvas);
                  }
              }
          }
          xhttp.open("GET", "{% url 'get_components' map_obj.pk %}");
          xhttp.send();
      }

      function prepareNewMarkerOffcanvas(event) {
          const offcanvas = document.getElementById('markerOffcanvas');
          const form = offcanvas.querySelector('form');
          form.reset();
          form.querySelector('input[name="id"]').value = '';
          form.querySelector('input[name="latitude"]').value = event.latlng.lat;
          form.querySelector('input[name="longitude"]').value = event.latlng.lng;

          bootstrap.Offcanvas.getOrCreateInstance(offcanvas).show();

          let marker = L.marker([event.latlng.lat, event.latlng.lng]).addTo(map);

          offcanvas.addEventListener('hide.bs.offcanvas', function() {
              map.removeLayer(marker);
          }, {once: true})
      }

      function prepareExistingMarkerOffcanvas(event) {
          const offcanvas = document.getElementById('markerOffcanvas');
          const form = offcanvas.querySelector('form');
          const marker = event.sourceTarget.options._data;
          form.querySelector('input[name="id"]').value = marker.id;
          form.querySelector('input[name="name"]').value = marker.name;
          form.querySelector('textarea[name="description"]').value = marker.description;
          form.querySelector('input[name="latitude"]').value = marker.latitude;
          form.querySelector('input[name="longitude"]').value = marker.longitude;
          form.querySelector('select[name="layer_id"]').value = marker.layer_id;
          form.querySelector('select[name="color"]').value = marker.color;
          form.querySelector('input[name="icon"]').value = marker.icon;
          form.querySelector('input[name="icon_color"]').value = marker.icon_color;
          bootstrap.Offcanvas.getOrCreateInstance(offcanvas).show();
      }

      function sendMarkerData() {
          const offcanvas = document.getElementById('markerOffcanvas');
          const form = offcanvas.querySelector('form');
          const xhttp = new XMLHttpRequest();
          xhttp.onload = function() {
              bootstrap.Offcanvas.getOrCreateInstance(offcanvas).hide();
              clearComponents();
              getComponents();
          }
          xhttp.open("POST", "{% url 'upsert_marker' map_obj.id %}");
          xhttp.setRequestHeader("Content-type", "application/json");
          xhttp.setRequestHeader("X-CSRFToken", csrftoken)
          xhttp.send(JSON.stringify({
              id: form.querySelector('input[name="id"]').value,
              name: form.querySelector('input[name="name"]').value,
              description: form.querySelector('textarea[name="description"]').value,
              latitude: form.querySelector('input[name="latitude"]').value,
              longitude: form.querySelector('input[name="longitude"]').value,
              layer_id: form.querySelector('select[name="layer_id"]').value,
              color: form.querySelector('select[name="color"]').value,
              icon: form.querySelector('input[name="icon"]').value,
              icon_color: form.querySelector('input[name="icon_color"]').value,
          }));
      }



  </script>

{% endblock %}
